<!DOCTYPE html>
<html lang="zh-Hant" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¼”å”±æœƒæ­Œå–®ç”Ÿæˆå™¨</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¼‰å…¥ Inter å­—é«” -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* åŸºæœ¬æ¨£å¼ */
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        /* æ·±è‰²æ¨¡å¼ä¸‹çš„è¡¨å–®æ¨£å¼ */
        .dark input, .dark textarea, .dark select {
            background-color: #374151; /* gray-700 */
            border-color: #4B5563; /* gray-600 */
            color: #F3F4F6; /* gray-100 */
        }
        
        /* æ²è»¸æ¨£å¼ */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .dark ::-webkit-scrollbar-track {
            background: #2d3748;
        }
        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 10px;
        }
        .dark ::-webkit-scrollbar-thumb {
            background: #4a5568;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        .dark ::-webkit-scrollbar-thumb:hover {
            background: #718096;
        }

        /* è¤‡è£½æŒ‰éˆ•çš„æç¤º */
        .copy-btn-tooltip {
            position: absolute;
            bottom: 110%;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
            white-space: nowrap;
        }
        .copy-btn:hover .copy-btn-tooltip {
            opacity: 1;
            visibility: visible;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen">

    <!-- æ¨™é¡Œèˆ‡æ·±è‰²æ¨¡å¼åˆ‡æ› -->
    <header class="container mx-auto px-4 py-6 flex justify-between items-center">
        <h1 class="text-3xl font-bold text-blue-600 dark:text-blue-400">æ¼”å”±æœƒæ­Œå–®ç”Ÿæˆå™¨</h1>
        <button id="darkModeToggle" class="p-2 rounded-full bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
            <svg id="sunIcon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
            <svg id="moonIcon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
        </button>
    </header>

    <!-- ä¸»å…§å®¹å€å¡Š -->
    <main class="container mx-auto px-4 grid grid-cols-1 md:grid-cols-2 gap-6 pb-12">
        
        <!-- å·¦å´ï¼šè¼¸å…¥å€ -->
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg space-y-4">
            <h2 class="text-xl font-semibold mb-2">1. å¡«å¯«åŸºæœ¬è³‡è¨Š</h2>
            
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <label for="eventDate" class="block text-sm font-medium text-gray-700 dark:text-gray-300">æ¼”å‡ºæ—¥æœŸ</label>
                    <input type="text" id="eventDate" placeholder="ä¾‹å¦‚: 250706" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>
                <div>
                    <label for="artistName" class="block text-sm font-medium text-gray-700 dark:text-gray-300">æ­Œæ‰‹åç¨±</label>
                    <input type="text" id="artistName" placeholder="ä¾‹å¦‚: HUR+" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>
            </div>
            <div>
                <label for="eventName" class="block text-sm font-medium text-gray-700 dark:text-gray-300">æ¼”å‡ºæ´»å‹•åç¨±</label>
                <input type="text" id="eventName" placeholder="ä¾‹å¦‚: 2025 è·¨å¹´æ¼”å”±æœƒ" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
            </div>

            <hr class="dark:border-gray-700">

            <h2 class="text-xl font-semibold mb-2 pt-2">2. è²¼ä¸Šæ­Œå–®å…§å®¹</h2>
            <textarea id="setlistInput" rows="15" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" placeholder="å¾ YouTube è³‡è¨Šæ¬„æˆ–å…¶ä»–åœ°æ–¹è²¼ä¸Šæ™‚é–“è»¸...
æ”¯æ´æ ¼å¼ï¼š
1. 00:00 Intro 03:41 Baddie
2. 0:00 (ä¸‹ä¸€è¡Œ) WheeIn
3. COCOCO (ä¸‹ä¸€è¡Œ) ACT LIKE THAT
..."></textarea>
            
            <button id="updateButton" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-colors shadow-md">
                æ›´æ–°æ­Œå–®
            </button>

            <hr class="dark:border-gray-700">

            <h2 class="text-xl font-semibold mb-2 pt-2">3. åŒ¯å‡ºæ­Œå–®</h2>
            <div class="grid grid-cols-2 gap-4">
                <button id="downloadTxt" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-colors shadow-md">
                    ä¸‹è¼‰ .TXT
                </button>
                <button id="downloadCsv" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition-colors shadow-md">
                    ä¸‹è¼‰ .CSV
                </button>
            </div>
        </div>

        <!-- å³å´ï¼šé è¦½å€ -->
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold">æ­Œå–®é è¦½</h2>
                <span id="songCount" class="text-sm font-medium text-gray-500 dark:text-gray-400 bg-gray-200 dark:bg-gray-700 px-3 py-1 rounded-full">
                    å…± 0 é …
                </span>
            </div>
            
            <div id="setlistOutput" class="h-[70vh] max-h-[700px] overflow-y-auto space-y-2 pr-2">
                <p class="text-gray-400 dark:text-gray-500 text-center pt-16">
                    è«‹åœ¨å·¦å´è²¼ä¸Šæ­Œå–®ä¸¦é»æ“Šã€Œæ›´æ–°æ­Œå–®ã€
                </p>
                <!-- æ­Œå–®é …ç›®å°‡å‹•æ…‹ç”Ÿæˆæ–¼æ­¤ -->
            </div>
        </div>

    </main>

    <!-- å‰ªè²¼ç°¿æ“ä½œç”¨çš„éš±è—å…ƒç´  -->
    <textarea id="clipboardHelper" class="absolute -left-full"></textarea>

    <!-- è¤‡è£½æˆåŠŸæç¤º -->
    <div id="copyAlert" class="hidden fixed bottom-10 left-1/2 -translate-x-1/2 bg-gray-900 text-white px-4 py-2 rounded-lg shadow-lg z-50">
        å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const $ = (selector) => document.querySelector(selector);
            const $$ = (selector) => document.querySelectorAll(selector);

            // --- DOM å…ƒç´  ---
            const body = document.body;
            const html = document.documentElement;
            const darkModeToggle = $('#darkModeToggle');
            const sunIcon = $('#sunIcon');
            const moonIcon = $('#moonIcon');
            
            const eventDate = $('#eventDate');
            const artistName = $('#artistName');
            const eventName = $('#eventName');
            const setlistInput = $('#setlistInput');
            const updateButton = $('#updateButton');
            
            const setlistOutput = $('#setlistOutput');
            const songCount = $('#songCount');
            
            const downloadTxt = $('#downloadTxt');
            const downloadCsv = $('#downloadCsv');
            const clipboardHelper = $('#clipboardHelper');
            const copyAlert = $('#copyAlert');

            let parsedItems = []; // ç”¨æ–¼å„²å­˜è§£æå¾Œçš„æ­Œå–®é …ç›®

            // --- æ·±è‰²æ¨¡å¼é‚è¼¯ ---
            const toggleDarkMode = (enable) => {
                if (enable) {
                    html.classList.add('dark');
                    sunIcon.classList.add('hidden');
                    moonIcon.classList.remove('hidden');
                    localStorage.setItem('theme', 'dark');
                } else {
                    html.classList.remove('dark');
                    sunIcon.classList.remove('hidden');
                    moonIcon.classList.add('hidden');
                    localStorage.setItem('theme', 'light');
                }
            };

            darkModeToggle.addEventListener('click', () => {
                toggleDarkMode(!html.classList.contains('dark'));
            });

            // æª¢æŸ¥ç³»çµ±æˆ–æœ¬åœ°å„²å­˜çš„åå¥½
            if (localStorage.getItem('theme') === 'dark' || 
                (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                toggleDarkMode(true);
            } else {
                toggleDarkMode(false);
            }

            // --- æ ¸å¿ƒåŠŸèƒ½ï¼šæ›´æ–°æ­Œå–® ---
            updateButton.addEventListener('click', () => {
                const text = setlistInput.value;
                parsedItems = parseSetlist(text);
                renderSetlist(parsedItems);
            });

            // --- æ­Œå–®è§£æé‚è¼¯ ---
            const parseSetlist = (text) => {
                const lines = text.split('\n');
                const items = [];
                const timeOnlyRegex = /^\d{1,2}:\d{2}(?::\d{2})?$/;
                const timeSplitRegex = /(\d{1,2}:\d{2}(?::\d{2})?)/; // ç”¨ä¾†åˆ‡å‰²æ™‚é–“çš„ regex

                for (let i = 0; i < lines.length; i++) {
                    let line = lines[i].trim();
                    if (line === '') continue;

                    // æª¢æŸ¥æ˜¯å¦ç‚ºæ¨™é ­ (ä¾‹å¦‚ï¼šå®‰å£æ›²ï¼š, ENCORE:)
                    if (line.endsWith('ï¼š') || line.toLowerCase().startsWith('encore')) {
                        items.push({ type: 'header', title: line });
                        continue;
                    }

                    // è©¦åœ–ç”¨æ™‚é–“æˆ³åˆ‡å‰²
                    const parts = line.split(timeSplitRegex).map(s => s.trim()).filter(Boolean);

                    // æ ¼å¼ 1: "00:00 intro 03:41 Baddie" or "00:00 intro"
                    // parts æœƒåƒ ["00:00", "intro", "03:41", "Baddie"]
                    if (parts.length > 1 && timeSplitRegex.test(parts[0])) {
                        for (let j = 0; j < parts.length; j += 2) {
                            const time = parts[j];
                            const title = parts[j + 1]; // å¯èƒ½æ˜¯ undefined
                            if (title) {
                                items.push({ ...categorize(title), time: time, title: title });
                            }
                        }
                        continue;
                    }

                    // æ ¼å¼ 2: "0:00" (é€™è¡Œ) å’Œ "WheeIn" (ä¸‹ä¸€è¡Œ)
                    if (parts.length === 1 && timeOnlyRegex.test(parts[0])) {
                        if (i + 1 < lines.length) {
                            const nextLine = lines[i + 1].trim();
                            // æª¢æŸ¥ä¸‹ä¸€è¡Œï¼šéç©ºã€éæ¨™é ­ã€éæ™‚é–“æˆ³
                            if (nextLine && !(nextLine.endsWith('ï¼š') || nextLine.toLowerCase().startsWith('encore')) && !timeOnlyRegex.test(nextLine.split(timeSplitRegex).map(s => s.trim()).filter(Boolean)[0])) {
                                items.push({ ...categorize(nextLine), time: parts[0], title: nextLine });
                                i++; // è·³éä¸‹ä¸€è¡Œï¼Œå› ç‚ºå·²ç¶“è™•ç†äº†
                                continue;
                            }
                        }
                        // å¦‚æœ "00:00" ä¸‹é¢æ²’æœ‰æœ‰æ•ˆæ­Œåï¼Œå°±æŠŠå®ƒç•¶ä½œæ ¼å¼ 3 è™•ç†
                    }

                    // æ ¼å¼ 3: "COCOCO" (åªæœ‰æ­Œå)
                    // ä¹Ÿæœƒæ•æ‰åˆ°ä¸Šé¢æ ¼å¼ 2 å¤±æ•—çš„ "00:00"
                    items.push({ ...categorize(line), time: null, title: line });
                }
                return items;
            };

            // --- é …ç›®åˆ†é¡ (åœ–ç¤º) ---
            const categorize = (title) => {
                const lower = title.toLowerCase();
                if (lower.includes('talk') || lower.includes('mc') || lower.includes('ment') || lower.includes('talking')) {
                    return { icon: 'ğŸ’¬', type: 'talk' };
                }
                if (lower.includes('photo') || lower.includes('å¤§åˆç…§') || lower.includes('åˆç…§')) {
                    return { icon: 'ğŸ“·', type: 'photo' };
                }
                if (lower.includes('intro') || lower.includes('outro') || lower.includes('vcr') || lower.includes('opening') || lower.includes('ending')) {
                    return { icon: 'ğŸ¬', type: 'movie' };
                }
                return { icon: 'ğŸµ', type: 'song' }; // é è¨­ç‚ºæ­Œæ›²
            };

            // --- æ¸²æŸ“åˆ—è¡¨ ---
            const renderSetlist = (items) => {
                setlistOutput.innerHTML = ''; // æ¸…ç©º
                if (items.length === 0) {
                    setlistOutput.innerHTML = '<p class="text-gray-400 dark:text-gray-500 text-center pt-16">æœªè§£æåˆ°ä»»ä½•é …ç›®ã€‚è«‹æª¢æŸ¥è¼¸å…¥æ ¼å¼ã€‚</p>';
                    songCount.textContent = 'å…± 0 é …';
                    return;
                }

                let itemCount = 0;
                items.forEach(item => {
                    if (item.type === 'header') {
                        const headerEl = document.createElement('h3');
                        headerEl.className = 'text-lg font-semibold text-blue-600 dark:text-blue-400 pt-3 pb-1 border-b-2 border-blue-200 dark:border-blue-800';
                        headerEl.textContent = item.title;
                        setlistOutput.appendChild(headerEl);
                    } else {
                        itemCount++;
                        const itemEl = document.createElement('div');
                        itemEl.className = 'flex items-center justify-between p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 group';
                        
                        const titleContent = `
                            <div class="flex items-center min-w-0">
                                <span class="text-xl mr-3">${item.icon}</span>
                                <div class="min-w-0">
                                    ${item.time ? `<span class="text-xs font-mono text-gray-500 dark:text-gray-400">${item.time}</span>` : ''}
                                    <p class="truncate font-medium">${item.title}</p>
                                </div>
                            </div>
                        `;
                        
                        const copyButton = `
                            <button class="copy-btn relative opacity-0 group-hover:opacity-100 transition-opacity bg-blue-100 dark:bg-blue-800 text-blue-600 dark:text-blue-300 px-3 py-1 rounded-full text-xs font-bold" data-title="${item.title.replace(/"/g, '&quot;')}">
                                è¤‡è£½
                                <span class="copy-btn-tooltip">è¤‡è£½ï¼š${item.title}</span>
                            </button>
                        `;

                        itemEl.innerHTML = titleContent + copyButton;
                        setlistOutput.appendChild(itemEl);
                    }
                });
                
                // æ›´æ–°è¨ˆæ•¸ï¼ˆä¸åŒ…å«æ¨™é ­ï¼‰
                songCount.textContent = `å…± ${itemCount} é …`;
            };

            // --- è¤‡è£½åŠŸèƒ½ ---
            setlistOutput.addEventListener('click', (e) => {
                if (e.target.classList.contains('copy-btn')) {
                    const title = e.target.dataset.title;
                    const dateVal = eventDate.value.trim();
                    const artistVal = artistName.value.trim();
                    const eventVal = eventName.value.trim();

                    // æ ¼å¼ï¼š 250706 HUR+ - Baddie @ 2025 è·¨å¹´æ¼”å”±æœƒ
                    let copyText = '';
                    if (dateVal) copyText += dateVal + ' ';
                    if (artistVal) copyText += artistVal + ' - ';
                    copyText += title;
                    if (eventVal) copyText += ' @ ' + eventVal;

                    // è¤‡è£½åˆ°å‰ªè²¼ç°¿
                    clipboardHelper.value = copyText;
                    clipboardHelper.select();
                    clipboardHelper.setSelectionRange(0, 99999); // For mobile
                    try {
                        document.execCommand('copy');
                        showCopyAlert();
                    } catch (err) {
                        console.error('ç„¡æ³•è¤‡è£½æ–‡å­—: ', err);
                    }
                }
            });

            // é¡¯ç¤ºè¤‡è£½æç¤º
            let alertTimer;
            const showCopyAlert = () => {
                clearTimeout(alertTimer);
                copyAlert.classList.remove('hidden');
                alertTimer = setTimeout(() => {
                    copyAlert.classList.add('hidden');
                }, 2000);
            };

            // --- ä¸‹è¼‰åŠŸèƒ½ ---
            downloadTxt.addEventListener('click', () => {
                if (parsedItems.length === 0) return;
                let content = '';
                parsedItems.forEach(item => {
                    if (item.type === 'header') {
                        content += `\n--- ${item.title} ---\n`;
                    } else {
                        content += `${item.time ? `[${item.time}]` : ''}\t${item.title}\n`;
                    }
                });
                downloadFile(content, 'setlist.txt', 'text/plain;charset=utf-8');
            });

            downloadCsv.addEventListener('click', () => {
                if (parsedItems.length === 0) return;
                let content = 'Time,Title,Type,Icon\n'; // CSV æ¨™é ­
                
                const escapeCSV = (str) => `"${str.replace(/"/g, '""')}"`;
                
                parsedItems.forEach(item => {
                    if (item.type !== 'header') {
                        content += [
                            escapeCSV(item.time || ''),
                            escapeCSV(item.title),
                            escapeCSV(item.type),
                            escapeCSV(item.icon)
                        ].join(',') + '\n';
                    }
                });
                downloadFile(content, 'setlist.csv', 'text/csv;charset=utf-8');
            });

            const downloadFile = (content, fileName, mimeType) => {
                const blob = new Blob([content], { type: mimeType });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };
        });
    </script>

</body>
</html>
